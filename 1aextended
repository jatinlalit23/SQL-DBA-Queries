CREATE EVENT SESSION [Track_Login_DB_Response] ON SERVER 
ADD EVENT sqlserver.login(
    ACTION(
        sqlserver.client_app_name, 
        sqlserver.client_hostname, 
        sqlserver.database_name, 
        sqlserver.nt_username, 
        sqlserver.server_principal_name, 
        sqlserver.session_id, 
        sqlserver.username, 
        sqlserver.server_name,
        sqlserver.client_connection_id,  -- Added for better connection tracking
        sqlserver.timestamp             -- Critical for timing calculations
    )),
ADD EVENT sqlserver.logout(
    ACTION(
        sqlserver.client_app_name, 
        sqlserver.client_hostname, 
        sqlserver.database_name, 
        sqlserver.nt_username, 
        sqlserver.server_principal_name, 
        sqlserver.session_id, 
        sqlserver.username, 
        sqlserver.server_name,
        sqlserver.client_connection_id,
        sqlserver.timestamp
    )),
ADD EVENT sqlserver.rpc_completed(
    ACTION(
        sqlserver.client_app_name, 
        sqlserver.client_hostname, 
        sqlserver.database_name, 
        sqlserver.nt_username, 
        sqlserver.server_principal_name, 
        sqlserver.session_id, 
        sqlserver.sql_text, 
        sqlserver.username, 
        sqlserver.server_name,
        sqlserver.client_connection_id,
        sqlserver.timestamp
    )
    WHERE ([duration]>(1000000))),
ADD EVENT sqlserver.sql_batch_completed(
    ACTION(
        sqlserver.client_app_name, 
        sqlserver.client_hostname, 
        sqlserver.database_name, 
        sqlserver.nt_username, 
        sqlserver.server_principal_name, 
        sqlserver.session_id, 
        sqlserver.sql_text, 
        sqlserver.username, 
        sqlserver.server_name,
        sqlserver.client_connection_id,
        sqlserver.timestamp
    )
    WHERE ([duration]>(1000000))),
-- Added attention event to track first query after login
ADD EVENT sqlserver.attention(
    ACTION(
        sqlserver.session_id,
        sqlserver.client_connection_id,
        sqlserver.timestamp
    )
    WHERE ([sqlserver].[is_first_result_set]=(1)))
ADD TARGET package0.event_file(SET filename=N'C:\XE\Track_Login_DB_Response.xel', max_file_size=(50), max_rollover_files=(5))
WITH (
    MAX_MEMORY=8192 KB,  -- Increased for additional events
    EVENT_RETENTION_MODE=ALLOW_SINGLE_EVENT_LOSS,
    MAX_DISPATCH_LATENCY=30 SECONDS,
    MAX_EVENT_SIZE=0 KB,
    MEMORY_PARTITION_MODE=NONE,
    TRACK_CAUSALITY=ON,  -- Enabled for connection tracking
    STARTUP_STATE=OFF
)
GO
